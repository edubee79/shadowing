<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadowing Master | 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css'); body { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }</style>
</head>
<body class="bg-slate-900 text-white min-h-screen font-pretendard">

    <div id="start-overlay" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center p-10 text-center">
        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl animate-bounce">
            <i class="fas fa-microphone text-3xl text-white"></i>
        </div>
        <h2 class="text-2xl font-black mb-2 tracking-tighter">학습 시작하기</h2>
        <p class="text-slate-400 font-bold text-sm mb-8">모바일 음성 인식을 활성화하기 위해<br>아래 버튼을 눌러주세요.</p>
        <button id="permission-btn" class="w-full max-w-xs py-5 bg-white text-slate-900 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">권한 허용 및 시작</button>
    </div>

    <nav class="p-6 flex justify-between items-center max-w-md mx-auto">
        <button onclick="location.reload()" class="text-slate-400"><i class="fas fa-rotate-left text-xl"></i></button>
        <h1 id="nav-title" class="font-black text-lg tracking-tighter italic text-indigo-400 uppercase">SHADOWING</h1>
        <div class="w-8"></div>
    </nav>

    <main class="max-w-md mx-auto px-6 pb-20 text-center">
        <div class="mb-10 flex justify-between items-end text-left">
            <div>
                <p class="text-indigo-500 text-[10px] font-black uppercase tracking-widest mb-1">Step 02. Shadowing</p>
                <h2 class="text-2xl font-black italic">Listen & Repeat</h2>
            </div>
            <div id="progress-area" class="text-right">
                <span id="progress-text" class="text-indigo-400 font-black text-2xl">1</span><span id="total-text" class="text-slate-700 font-bold text-lg"> / --</span>
            </div>
        </div>

        <div class="bg-white rounded-[3rem] p-10 shadow-2xl mb-10 relative overflow-hidden min-h-[250px] flex items-center justify-center">
            <div id="sentence-box" class="blur-md transition-all duration-700">
                <p id="target-sentence" class="text-slate-900 font-black text-2xl leading-tight italic mb-4 tracking-tight"></p>
                <p id="sentence-mean" class="text-slate-400 font-bold text-sm"></p>
                <p id="attempt-counter" class="mt-4 text-[10px] font-bold text-rose-500 uppercase tracking-widest"></p>
            </div>
            <div id="play-overlay" class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm">
                <button id="real-play-btn" class="w-24 h-24 bg-indigo-600 rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-transform">
                    <i class="fas fa-play text-white text-4xl ml-1"></i>
                </button>
            </div>
        </div>

        <div class="space-y-6">
            <div id="status-msg" class="text-slate-500 font-black text-[10px] uppercase tracking-widest">중앙 버튼을 눌러 소리를 들으세요</div>
            <button id="mic-btn" disabled class="w-full py-8 bg-slate-800 text-slate-600 rounded-[2.5rem] text-xl font-black transition-all">
                <i class="fas fa-microphone mr-3"></i> 소리를 먼저 들으세요
            </button>
            <p id="user-transcript" class="text-indigo-400 font-bold italic text-sm min-h-[1.5rem]"></p>
        </div>
    </main>

    <script type="module">
        const allShadowData = { 1: [{en: "Some people are gathered around a table.", ko: "사람들이 테이블에 둘러앉아 있다."}, {en: "He is leaning against the railing.", ko: "그는 난간에 기대어 있다."}, {en: "A woman is reaching for an item.", ko: "여자가 물건을 잡으려고 손을 뻗고 있다."}] };

        let recognition = null;
        const synth = window.speechSynthesis;
        let currentIndex = 0;
        let attemptCount = 0; 
        let currentDayData = allShadowData[1];

        document.getElementById('permission-btn').addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());

                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;

                recognition.onresult = (event) => handleResult(event.results[0][0].transcript);
                recognition.onerror = () => resetMicBtn();
                recognition.onend = () => resetMicBtn();

                synth.speak(new SpeechSynthesisUtterance(""));
                document.getElementById('start-overlay').classList.add('hidden');
                loadSentence();
            } catch (err) {
                alert("마이크 권한 허용이 필요합니다.");
            }
        }, { once: true });

        function loadSentence() {
            const data = currentDayData[currentIndex];
            attemptCount = 0; 
            updateAttemptUI();

            document.getElementById('target-sentence').innerText = data.en;
            document.getElementById('sentence-mean').innerText = data.ko;
            document.getElementById('total-text').innerText = " / " + currentDayData.length;
            document.getElementById('progress-text').innerText = currentIndex + 1;
            
            document.getElementById('sentence-box').classList.add('blur-md');
            document.getElementById('play-overlay').style.display = 'flex';
            document.getElementById('mic-btn').disabled = true;
            document.getElementById('mic-btn').innerText = "소리를 먼저 들으세요";
            document.getElementById('mic-btn').className = "w-full py-8 bg-slate-800 text-slate-600 rounded-[2.5rem] text-xl font-black";
        }

        document.getElementById('real-play-btn').onclick = () => {
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(currentDayData[currentIndex].en);
            utter.lang = 'en-US';
            utter.rate = 0.8;
            utter.onend = () => {
                document.getElementById('sentence-box').classList.remove('blur-md');
                document.getElementById('play-overlay').style.display = 'none';
                document.getElementById('mic-btn').disabled = false;
                document.getElementById('mic-btn').className = "w-full py-8 bg-indigo-600 text-white rounded-[2.5rem] text-xl font-black";
                document.getElementById('mic-btn').innerText = "마이크 누르고 따라하기";
            };
            synth.speak(utter);
        };

        document.getElementById('mic-btn').onclick = () => {
            if (!recognition) return;
            recognition.start();
            document.getElementById('mic-btn').innerText = "듣고 있습니다...";
            document.getElementById('mic-btn').className = "w-full py-8 bg-rose-500 text-white rounded-[2.5rem] text-xl font-black scale-95";
        };

        function handleResult(speech) {
            document.getElementById('user-transcript').innerText = `내 발음: "${speech}"`;
            const target = currentDayData[currentIndex].en.toLowerCase().replace(/[.,!?]/g, "");
            const result = speech.toLowerCase().replace(/[.,!?]/g, "");

            if (result.includes(target) || result.split(' ').length > 3) {
                alert("Great!");
                nextSentence();
            } else {
                attemptCount++;
                updateAttemptUI();
                if (attemptCount >= 5) {
                    alert("5번 시도 실패! 다음 문장으로 넘어갑니다.");
                    nextSentence();
                } else {
                    alert(`${attemptCount}회 실패! 다시 한 번 들려드릴게요.`);
                    document.getElementById('real-play-btn').click(); 
                }
            }
        }

        function nextSentence() {
            currentIndex++;
            if (currentIndex < currentDayData.length) {
                loadSentence();
            } else {
                alert("오늘의 쉐도잉 학습을 모두 마쳤습니다!");
                location.href = "index.html"; 
            }
        }

        function updateAttemptUI() {
            const counterEl = document.getElementById('attempt-counter');
            if (attemptCount > 0) {
                counterEl.innerText = `Attempt: ${attemptCount} / 5`;
            } else {
                counterEl.innerText = "";
            }
        }

        function resetMicBtn() {
            const btn = document.getElementById('mic-btn');
            if(!btn.disabled) {
                btn.innerText = "마이크 누르고 따라하기";
                btn.className = "w-full py-8 bg-indigo-600 text-white rounded-[2.5rem] text-xl font-black";
            }
        }
    </script>
</body>
</html>